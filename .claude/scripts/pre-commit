#!/bin/bash
# Git pre-commit hook for x.uma
# Validates proto, Rust, and arch constraints before commit
# Sources project-paths.sh for canonical path definitions

set -e

# Resolve symlinks to find the actual script directory
# This handles the case where the hook is symlinked from .git/hooks/
SCRIPT_SOURCE="${BASH_SOURCE[0]}"
while [ -L "$SCRIPT_SOURCE" ]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_SOURCE")" && pwd)"
    SCRIPT_SOURCE="$(readlink "$SCRIPT_SOURCE")"
    [[ $SCRIPT_SOURCE != /* ]] && SCRIPT_SOURCE="$SCRIPT_DIR/$SCRIPT_SOURCE"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_SOURCE")" && pwd)"

source "${SCRIPT_DIR}/project-paths.sh"

cd "$XUMA_ROOT"

echo "=== x.uma Pre-commit Validation ==="
echo ""

# 0. Path consistency check
echo ">>> Path Consistency"
"${SCRIPTS_DIR}/check-path-consistency.sh" || { echo "Path references broken - update project-paths.sh"; exit 1; }
echo ""

# 1. Proto validation (if any proto files staged)
if git diff --cached --name-only | grep -q "\.proto$"; then
    echo ">>> Proto Validation"
    buf lint "$PROTO_DIR/" || { echo "Proto lint failed"; exit 1; }

    # Check for breaking changes if on a branch
    BRANCH=$(git rev-parse --abbrev-ref HEAD)
    if [ "$BRANCH" != "main" ]; then
        echo "Checking for breaking changes..."
        buf breaking "$PROTO_DIR/" --against ".git#branch=main" || { echo "Breaking change detected"; exit 1; }
    fi
    echo ""
fi

# 2. Rust validation (if any Rust files staged)
if git diff --cached --name-only | grep -q "\.rs$"; then
    echo ">>> Rust Validation"

    # Check if fixes needed (don't fail yet)
    NEEDS_FMT=0
    NEEDS_CLIPPY=0

    cargo fmt --manifest-path "$RUST_MANIFEST" --all -- --check 2>/dev/null || NEEDS_FMT=1
    cargo clippy --manifest-path "$RUST_MANIFEST" --workspace -- -W clippy::pedantic -D warnings 2>/dev/null || NEEDS_CLIPPY=1

    # Auto-fix if needed, then fail so user re-stages
    if [ "$NEEDS_CLIPPY" -eq 1 ] || [ "$NEEDS_FMT" -eq 1 ]; then
        echo "Auto-fixing issues..."
        cargo clippy --manifest-path "$RUST_MANIFEST" --workspace --fix --allow-dirty -- -W clippy::pedantic 2>/dev/null || true
        cargo fmt --manifest-path "$RUST_MANIFEST" --all
        echo ""
        echo "Files fixed. Run 'git add -u && git commit' again."
        exit 1
    fi

    echo "Format and clippy: OK"

    # Tests
    echo "Running tests..."
    cargo test --manifest-path "$RUST_MANIFEST" --workspace || { echo "Tests failed"; exit 1; }

    # no_std check (core only) â€” disabled until no_std is implemented
    # echo "Verifying no_std compatibility..."
    # cargo build --manifest-path "$RUST_MANIFEST" -p "$CRATE_CORE_PACKAGE" --no-default-features --features alloc || { echo "no_std build failed"; exit 1; }

    echo ""
fi

# 3. Arch constraint validation
echo ">>> Arch Constraint Validation"
"${SCRIPTS_DIR}/check-constraints.sh" || { echo "Constraint check failed"; exit 1; }

echo ""
echo "=== All checks passed ==="
